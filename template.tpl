___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Chartbeat Web Tracking Tag",
  "categories": ["ANALYTICS"],
  "brand": {
    "id": "github.com_gtm-chartbeat",
    "displayName": "gtm-chartbeat",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Start your real-time analysis with this Chartbeat tag.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "uid",
    "displayName": "UID",
    "simpleValueType": true,
    "notSetText": "A numerical id value associated with your Chartbeat account",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^\\d{3,6}$"
        ],
        "errorMessage": "Three to six digits",
        "enablingConditions": []
      },
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "123456",
    "help": "A numerical id value associated with your Chartbeat account, three to six digits in length"
  },
  {
    "type": "TEXT",
    "name": "domain",
    "displayName": "Domain",
    "simpleValueType": true,
    "help": "This value should be set to the Chartbeat site id (site name) for your website. This is usually the root domain without http or \u0027www.\u0027 prepended",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "mysite.com",
    "notSetText": "Chartbeat site name"
  },
  {
    "type": "GROUP",
    "name": "recommendedGroup",
    "displayName": "Recommended Fields And Settings",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "sections",
        "displayName": "Sections",
        "simpleValueType": true,
        "notSetText": "Page sections",
        "canBeEmptyString": true,
        "help": "10 comma-separated sections max, 64 characters per section. Take a look at the \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#sections-and-authors\"\u003eofficial docs\u003c/a\u003e for more information",
        "valueHint": "News,Sports,Local",
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "^[^,]*(,.*)*$"
            ],
            "errorMessage": "Please enter a comma separated list"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "authors",
        "displayName": "Authors",
        "simpleValueType": true,
        "canBeEmptyString": true,
        "notSetText": "Page authors",
        "help": "10 comma-separated authors max, 63 characters per author. Take a look at the \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#sections-and-authors\"\u003eofficial docs\u003c/a\u003e for more information",
        "valueHint": "Megan Summers,Kevin Smith",
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "^[^,]*(,.*)*$"
            ],
            "errorMessage": "Please enter a comma separated list"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "canonical",
        "checkboxText": "Use path portion of your canonical URL for the Chartbeat page path",
        "simpleValueType": true,
        "displayName": "Use Canonical",
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#canonical-page-path\"\u003ethe official docs\u003c/a\u003e",
        "defaultValue": true
      },
      {
        "type": "CHECKBOX",
        "name": "canonicalDomain",
        "checkboxText": "Use domain portion of your canonical URL for the Chartbeat page path",
        "simpleValueType": true,
        "displayName": "Use Canonical Domain",
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#canonical-page-path\"\u003ethe official docs\u003c/a\u003e",
        "defaultValue": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "additionalGroup",
    "displayName": "Additional Fields and Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "customPath",
        "displayName": "Custom Path",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#custom-path\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "pageTitle",
        "displayName": "Page Title",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#page-title\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "contentType",
        "displayName": "Content Type",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#content-type\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "CHECKBOX",
        "name": "mobileApp",
        "checkboxText": "Mobile App",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#mobile-app\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "virtualReferrer",
        "displayName": "Virtual Referrer",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#virtual-referrer\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "CHECKBOX",
        "name": "noCookies",
        "checkboxText": "No Cookies",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#no-cookies\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "pathAlias",
        "displayName": "Path Alias",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#path-alias\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "sponsorName",
        "displayName": "Sponsor Name",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#sponsor-name\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "CHECKBOX",
        "name": "scrollElement",
        "checkboxText": "Scroll Element",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#scroll-element\"\u003ethe official docs\u003c/a\u003e"
      },
      {
        "type": "TEXT",
        "name": "cookieDomain",
        "displayName": "Cookie Domain",
        "simpleValueType": true,
        "help": "If unsure, please have a look at \u003ca href\u003d\"https://docs.chartbeat.com/cbp/tracking/standard-websites/configuration-variables#cookie-domain\"\u003ethe official docs\u003c/a\u003e"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const setInWindow = require('setInWindow');
const injectScript = require('injectScript');

// required
const uid = data.uid;
const domain = data.domain;
// recommended
const canonical = data.canonical;
const canonicalDomain = data.canonicalDomain;
const sections = data.sections;
const authors = data.authors;
// additional
const customPath = data.customPath;
const pageTitle = data.pageTitle;
const contentType = data.contentType;
const mobileApp = data.mobileApp;
const virtualReferrer = data.virtualReferrer;
const noCookies = data.noCookies;
const pathAlias = data.pathAlias;
const sponsorName = data.sponsorName;
const scrollElement = data.scrollElement;
const cookieDomain = data.cookieDomain;
 
// remove empty entries from comma separated list, truncate entries (> 64 chars) and list (> 10)
function toChartbeatListFormat(comSepList) {
  if (!comSepList) return undefined;
  
  return comSepList.split(',')
    .map(e => {
      let et = e.trim();
      if (et.length > 64) et = et.substring(0, 64);
      return et;
    })
    .filter(e => e.length > 0)
    .slice(0, 10)
    .join(',');
}

const config = {};
config.uid = uid;
config.domain = domain;
config.useCanonical = canonical;
config.useCanonicalDomain = canonicalDomain;
config.sections = toChartbeatListFormat(sections);
config.authors = toChartbeatListFormat(authors);
config.customPath = customPath;
config.pageTitle = pageTitle;
config.mobileApp = mobileApp;
config.virtualReferrer = virtualReferrer;
config.noCookies = noCookies;
config.pathAlias = pathAlias;
config.sponsorName = sponsorName;
config.scrollElement = scrollElement;
config.cookieDomain = cookieDomain;

setInWindow('_sf_async_config', config, true);

const url = 'https://static.chartbeat.com/js/chartbeat.js';
injectScript(url, data.gtmOnSuccess, data.gtmOnFailure, url);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_sf_async_config"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://static.chartbeat.com/js/chartbeat.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: API Call Flow
  code: |-
    const mockData = {
      uid: '12345',
      domain: 'dummy.info'
    };

    runCode(mockData);

    assertApi('setInWindow').wasCalled();
    assertApi('injectScript').wasCalled();

    assertApi('gtmOnSuccess').wasCalled();
- name: Remove Empty Authors
  code: |-
    const mockData = {
      authors: 'author1   ,,author2,,,'
    };

    mock('setInWindow', function(key, value, overrideExisting) {
      assertThat(value.authors).isEqualTo('author1,author2');
    });

    runCode(mockData);

    assertApi('setInWindow').wasCalled();
- name: Max 10 Sections
  code: |-
    const mockData = {
      sections: 's1,s2,s3,s4,s5,s6,s7,s8,s9,s10,s11,s12'
    };

    mock('setInWindow', function(key, value, overrideExisting) {
      assertThat(value.sections).isEqualTo('s1,s2,s3,s4,s5,s6,s7,s8,s9,s10');
    });

    runCode(mockData);

    assertApi('setInWindow').wasCalled();
- name: Max 64 Chars per Author
  code: |-
    const mockData = {
      authors: 'gdjfhgkgeurhggkjjdkhjkdfhgkjdfhgjkdhadhjagiurufhurefhfelrsdhkjjfghrzgrefklljhjk'
    };

    assertThat(mockData.authors.length).isGreaterThan(64);

    mock('setInWindow', function(key, value, overrideExisting) {
      assertThat(value.authors.length).isEqualTo(64);
    });

    runCode(mockData);

    assertApi('setInWindow').wasCalled();
- name: Set _sf_async_config
  code: |-
    const mockData = {};

    mock('setInWindow', function(key, value, overrideExisting) {
      assertThat(key).isEqualTo('_sf_async_config');
    });

    runCode(mockData);

    assertApi('setInWindow').wasCalled();
setup: |-
  // no need to load/inject real js for test purposes
  mock('injectScript', function(url, suc, err) {
    suc();
  });


___NOTES___

Created on 10.2.2022, 16:12:59


